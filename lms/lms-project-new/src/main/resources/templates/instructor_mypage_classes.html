<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security6"
      layout:decorate="~{instructor_mypage_layout}">

<head>
    <title th:text="${instructor.userName} + ' 님의 강의 목록'"></title>
</head>

<body>
    <th:block layout:fragment="mypage_content">
        <div class="container my-4">

            <section>
                 <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <h3 class="mb-0 fw-bold" th:text="${instructor.userName} + ' 님의 강의 목록'"></h3>
                        <span class="text-muted small" th:text="|총 ${paging.totalElements}개 강의 (수강생 많은 순)|"></span>
                    </div>
                </div>
                
                <div class="row justify-content-end mb-4">
                    <div class="col-md-8">
                        <form th:action="@{/instructor/classes}" method="get" id="searchForm" class="input-group">
                            <input type="hidden" id="page" name="page" th:value="${paging.number}">
                            
                            <select class="form-select" name="levelId" id="levelId" style="max-width: 150px;">
                                <option value="0" th:selected="${levelId == null or levelId == 0}">전체 난이도</option>
                                <option value="1" th:selected="${levelId == 1}">초급</option>
                                <option value="2" th:selected="${levelId == 2}">중급</option>
                                <option value="3" th:selected="${levelId == 3}">고급</option>
                            </select>
                            
                            <input type="text" id="search_kw" name="kw" class="form-control" 
                                   th:value="${kw}" placeholder="강의 제목 검색">
                            
                            <button class="btn btn-outline-secondary" type="button" id="btn_search">검색</button>
                        </form>
                    </div>
                </div>

                <div class="row g-3">
                    <div th:if="${!paging.hasContent()}" class="col-12">
                        <div class="alert alert-secondary text-center" role="alert">
                            등록된 강의가 없습니다.
                        </div>
                    </div>

                    <div class="col-12 col-md-6 col-lg-4" th:each="classes : ${paging}">
                        <div class="card h-100 shadow-sm">
                           <div class="position-relative overflow-hidden" style="height: 200px;">
                               <img th:if="${classes.classesImg != null}" th:src="${classes.classesImg}"
                                    class="card-img-top w-100 h-100 object-fit-cover" alt="강의 이미지">
                               <div th:unless="${classes.classesImg != null}" 
                                    class="card-img-top w-100 h-100 bg-secondary d-flex align-items-center justify-content-center text-white">
                                   <span>이미지 없음</span>
                               </div>
                           </div>

                           <div class="card-body d-flex flex-column">
                               <h5 class="card-title fw-bold text-truncate" th:text="${classes.title}"></h5>
                               
                               <div class="mb-2">
                                    <span class="badge"
                                         th:text="${classes.level?.levelName ?: 'N/A'}"
                                         th:classappend="${classes.level == null ? 'bg-secondary' : 
                                                          (classes.level.levelId == 1 ? 'bg-info' : 
                                                          (classes.level.levelId == 2 ? 'bg-primary' : 'bg-danger'))}">
                                   </span>
                               </div>
                               
                               <p class="card-text text-truncate" th:text="${classes.classesContent}"></p>
                               
                               <p class="card-text text-muted small mb-2">
                                   <i class="bi bi-people-fill"></i> 
                                   수강생: <span th:text="${enrollmentCountMap[classes.classesId] ?: 0}">0</span>명
                               </p>

                               <div class="mt-auto d-flex justify-content-between gap-1">
                                   <a th:href="@{|/classes/${classes.classesId}|}" class="btn btn-sm btn-outline-primary flex-grow-1">강의 보기</a>
                                   
                                   <a th:href="@{|/enrollment/classes/${classes.classesId}|}" class="btn btn-sm btn-outline-success flex-grow-1">
                                       <i class="bi bi-list-ul"></i> 수강생
                                   </a>
                                   
                                   <a th:href="@{|/classes/edit/${classes.classesId}|}" class="btn btn-sm btn-outline-secondary flex-grow-1">수정</a>
                               </div>
                           </div>
                        </div>
                    </div>
                </div>

                <div th:if="${paging != null and paging.totalPages > 1}" 
                     class="mt-4">
                     <div th:replace="~{pagination :: paging(paging=${paging})}"></div>
                     </div>

            </section>

        </div>

        <script layout:fragment="script" type='text/javascript'>
            // 1. 페이징 버튼 클릭 처리
            const page_elements = document.getElementsByClassName("page-link");
            Array.from(page_elements).forEach(function(element) {
                element.addEventListener('click', function() {
                    document.getElementById('page').value = this.dataset.page;
                    document.getElementById('searchForm').submit();
                });
            });

            // 2. 검색 버튼 클릭 처리
            const btn_search = document.getElementById("btn_search");
            if(btn_search) {
                btn_search.addEventListener('click', function() {
                    document.getElementById('page').value = 0; // 검색 시 1페이지부터
                    document.getElementById('searchForm').submit();
                });
            }
            
            // 3. 드롭다운 변경 시 자동 검색 (선택사항)
            const select_level = document.getElementById("levelId");
            if(select_level) {
                select_level.addEventListener('change', function() {
                    document.getElementById('page').value = 0;
                    document.getElementById('searchForm').submit();
                });
            }
        </script>
    </th:block>
</body>
</html>