<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout}">

<head>
	<title th:text="|μμƒ μ‹μ²­: ${classes.title}|">κ°•μ μμƒ</title>
</head>

<body>
	<th:block layout:fragment="content">

		<!-- [μ‚­μ ] 10λ¶„ νƒ€μ΄λ¨Έ μ•λ¦Όμ© λ¨λ‹¬ μ „μ²΄ μ‚­μ  -->
		<!-- <div id="watch-alert-modal" ...> ... </div> -->

		<div class="container my-4">

			<!-- νμ΄μ§€ μ λ© -->
			<div class="d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom">
				<div>
					<h2 class="fw-bold" th:text="${classes.title}">κ°•μ μ λ©</h2>
					<span class="text-muted">
						<i class="bi bi-person-fill me-1"></i>
						<span th:text="${classes?.user?.userName}">κ°•μ‚¬λ…</span>
					</span>
				</div>
				<a th:href="@{/classes/{id}(id=${classes.classesId})}" class="btn btn-secondary">
					<i class="bi bi-arrow-left-short"></i> κ°•μ μƒμ„Έλ΅ λμ•„κ°€κΈ°
				</a>
			</div>

			<!-- 1. λΉ„λ””μ¤ μμƒμ΄ μλ” κ²½μ° -->
			<div class="mb-4" th:if="${videoUrl != null and !videoUrl.isEmpty()}">
				<div class="d-flex justify-content-between align-items-center mb-3">
					<h4 class="fw-bold mb-0">π¬ κ°•μ μμƒ</h4>
					<div>

						<!-- μ§λ¬Έν•κΈ° λ²„νΌ μ¶”κ°€ -->
						<a th:if="${isEnrolled}" th:href="@{/question/create(classesId=${classes.classesId})}"
							class="btn btn-dark ms-2">
							<i class="bi bi-play-circle-fill"></i> μ§λ¬Έν•κΈ°
						</a>

						<!-- μκ°• μ™„λ£ λ²„νΌ -->
						<form th:if="${isEnrolled and !isCompleted}" id="watch-form-video"
							th:action="@{/enrollment/complete/{id}(id=${classes.classesId})}" method="post"
							style="display:inline;">
							<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
							<!-- [μ‹ κ·] μ‹μ²­ μ‹κ°„μ„ μ„λ²„λ΅ μ „μ†΅ν•  hidden input -->
							<input type="hidden" name="watch_duration" value="0" />
							<button type="submit" class="btn btn-info ms-2">
								<i class="bi bi-check-circle-fill"></i> μκ°• μ™„λ£
							</button>
						</form>
						<!-- κ²½κ³Ό μ‹κ°„ ν‘μ‹κΈ° -->
						<span th:if="${isEnrolled and !isCompleted}" id="watch-timer-video"
							class="badge bg-secondary align-middle ms-2"
							style="min-width: 4em; font-variant-numeric: tabular-nums;">00:00</span>

						<!-- μκ°• μ™„λ£λ¨ λ°°μ§€ -->
						<span th:if="${isEnrolled and isCompleted}" class="btn btn-outline-success ms-2 disabled">
							<i class="bi bi-check-lg"></i> μκ°• μ™„λ£λ¨
						</span>
					</div>
				</div>

				<div class="card shadow-sm">
					<!-- ... (iframe, video νƒκ·Έ λ“± μμƒ κ΄€λ ¨ μ½”λ“λ” λ™μΌ) ... -->
					<div class="card-body ratio ratio-16x9">
						<th:block th:with="
					        isYoutubeWatch=${#strings.contains(videoUrl, 'youtube.com/watch?v=')},
					        isYoutubeShort=${#strings.contains(videoUrl, 'youtu.be/')},
					        isYoutubeEmbed=${#strings.contains(videoUrl, 'youtube.com/embed/')},
					        baseUrl=${isYoutubeEmbed ? videoUrl : (isYoutubeWatch ? #strings.replace(videoUrl, 'watch?v=', 'embed/') : (isYoutubeShort ? #strings.replace(videoUrl, 'youtu.be/', 'https://www.youtube.com/embed/') : videoUrl))},
					        separator=${#strings.contains(baseUrl, '?') ? '&' : '?'},
					        finalUrl=${baseUrl + separator + 'autoplay=1&mute=1'}
					    ">
							<iframe th:if="${isYoutubeWatch or isYoutubeShort or isYoutubeEmbed}" th:src="${finalUrl}"
								title="YouTube video player" frameborder="0"
								allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
								allowfullscreen>
							</iframe>

							<video th:unless="${isYoutubeWatch or isYoutubeShort or isYoutubeEmbed}"
								th:src="@{${videoUrl}}" controls width="100%" autoplay muted>
							</video>
						</th:block>
					</div>
				</div>
			</div>

			<!-- 2. λΉ„λ””μ¤ μμƒμ΄ μ—†λ” κ²½μ° -->
			<div class="mb-4" th:if="${videoUrl == null or videoUrl.isEmpty()}">
				<div class="d-flex justify-content-between align-items-center mb-3">
					<h4 class="fw-bold mb-0">π¬ κ°•μ μμƒ</h4>
					<div>

						<!-- μ§λ¬Έν•κΈ° λ²„νΌ μ¶”κ°€ -->
						<a th:if="${isEnrolled}" th:href="@{/question/create(classesId=${classes.classesId})}"
							class="btn btn-dark ms-2">
							<i class="bi bi-play-circle-fill"></i> μ§λ¬Έν•κΈ°
						</a>

						<!-- μκ°• μ™„λ£ λ²„νΌ (μμƒ μ—†λ” κ²½μ°) -->
						<form th:if="${isEnrolled and !isCompleted}" id="watch-form-no-video"
							th:action="@{/enrollment/complete/{id}(id=${classes.classesId})}" method="post"
							style="display:inline;">
							<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
							<!-- [μ‹ κ·] μ‹μ²­ μ‹κ°„μ„ μ„λ²„λ΅ μ „μ†΅ν•  hidden input -->
							<input type="hidden" name="watch_duration" value="0" />
							<button type="submit" class="btn btn-info ms-2">
								<i class="bi bi-check-circle-fill"></i> μκ°• μ™„λ£
							</button>
						</form>
						<!-- κ²½κ³Ό μ‹κ°„ ν‘μ‹κΈ° (μμƒ μ—†λ” κ²½μ°) -->
						<span th:if="${isEnrolled and !isCompleted}" id="watch-timer-no-video"
							class="badge bg-secondary align-middle ms-2"
							style="min-width: 4em; font-variant-numeric: tabular-nums;">00:00</span>

						<span th:if="${isEnrolled and isCompleted}" class="btn btn-outline-success ms-2 disabled">
							<i class="bi bi-check-lg"></i> μκ°• μ™„λ£λ¨
						</span>
					</div>
				</div>

				<div class="card shadow-sm">
					<!-- ... (μμƒ μ—†μ placeholder μ½”λ“λ” λ™μΌ) ... -->
					<div class="card-body text-center p-5"
						style="min-height: 200px; display: flex; align-items: center; justify-content: center; flex-direction: column;">
						<i class="bi bi-camera-video-off display-3 text-muted"></i>
						<p class="mt-3 text-muted">λ“±λ΅λ κ°•μ μμƒμ΄ μ—†μµλ‹λ‹¤.</p>
					</div>
				</div>
			</div>

			<!-- 3. κ°•μ μ†κ° -->
			<div class="mt-4">
				<h4 class="fw-bold mb-3">κ°•μ μ†κ°</h4>
				<p th:text="${classes?.classesContent}">
					κ°•μ μ†κ° λ‚΄μ©...
				</p>
			</div>

		</div>
	</th:block>

	<!-- [μμ •] 10λ¶„ νƒ€μ΄λ¨Έ + LocalStorage + Flash μ•λ¦Ό λ°©μ‹μΌλ΅ μ¤ν¬λ¦½νΈ μμ • -->
	<th:block layout:fragment="script">
		<script th:inline="javascript">

			// μ„λ²„μ—μ„ λ°›μ€ λ³€μλ“¤
			const currentUserId = /*[[${currentUserId}]]*/ 'user_guest';
			const classesId = /*[[${classes.classesId}]]*/ 0;
			const csrfToken = /*[[${_csrf.token}]]*/ '';
			const csrfHeader = /*[[${_csrf.headerName}]]*/ '';
			const isCompleted = /*[[${isCompleted}]]*/ false; // μ΄λ―Έ μ™„λ£ν–λ”μ§€ μ—¬λ¶€

			const storageKey = `watchTime_${currentUserId}_${classesId}`;
			const targetSeconds = 20; // λ©ν‘ μ‹κ°„ 20μ΄

			// 1. LocalStorage ν•¨μ (λ™μΌ)
			function loadSavedTime() {
				const savedSeconds = localStorage.getItem(storageKey);
				return savedSeconds ? parseInt(savedSeconds, 10) : 0;
			}
			function saveTime(seconds) {
				localStorage.setItem(storageKey, seconds);
			}
			function formatTime(totalSeconds) {
				const minutes = Math.floor(totalSeconds / 60);
				const seconds = totalSeconds % 60;
				return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
			}

			document.addEventListener("DOMContentLoaded", function () {

				// μ΄λ―Έ μκ°• μ™„λ£λ μƒνƒλΌλ©΄ νƒ€μ΄λ¨Έ λ΅μ§ μ‹¤ν–‰ μ• ν•¨ (μ„ νƒμ‚¬ν•­)
				// if (isCompleted) return; 

				const timerDisplayVideo = document.getElementById('watch-timer-video');
				const timerDisplayNoVideo = document.getElementById('watch-timer-no-video');

				let initialSeconds = loadSavedTime();
				// νμ΄μ§€ λ΅λ“ μ‹μ μ„ κΈ°μ¤€μΌλ΅ κ²½κ³Ό μ‹κ°„ κ³„μ‚°
				const pageLoadTime = new Date().getTime() - (initialSeconds * 1000);

				// [ν•µμ‹¬] 1μ΄λ§λ‹¤ μ‹¤ν–‰λλ” νƒ€μ΄λ¨Έ
				const timerInterval = setInterval(() => {
					// 1. ν„μ¬κΉμ§€ λ³Έ μ‹κ°„(μ΄) κ³„μ‚°
					const elapsedSeconds = Math.floor((new Date().getTime() - pageLoadTime) / 1000);

					// 2. UI μ—…λ°μ΄νΈ (μ‹κ°„ ν‘μ‹)
					const formattedTime = formatTime(elapsedSeconds);
					if (timerDisplayVideo) timerDisplayVideo.textContent = formattedTime;
					if (timerDisplayNoVideo) timerDisplayNoVideo.textContent = formattedTime;

					// 3. 20μ΄ λ‹¬μ„± μ‹ μ‹κ°μ  ν‘μ‹ (μ΄λ΅μƒ‰ λ³€κ²½)
					if (elapsedSeconds >= targetSeconds) {
						if (timerDisplayVideo) {
							timerDisplayVideo.classList.remove('bg-secondary');
							timerDisplayVideo.classList.add('bg-success');
							timerDisplayVideo.textContent = "μ™„λ£ (" + formattedTime + ")";
						}
						if (timerDisplayNoVideo) {
							timerDisplayNoVideo.classList.remove('bg-secondary');
							timerDisplayNoVideo.classList.add('bg-success');
						}
					}

					// 4. LocalStorage μ €μ¥
					saveTime(elapsedSeconds);

					// 5. [AJAX] μ„λ²„λ΅ μ§„λ„μ¨ μ „μ†΅ (1μ΄λ§λ‹¤)
					// μ„λ²„ λ¶€ν•κ°€ κ±±μ •λλ©΄ μ΄ λ¶€λ¶„μ„ if (elapsedSeconds % 5 === 0) λ“±μΌλ΅ κ°μ‹Έμ„ 5μ΄ μ£ΌκΈ°λ΅ λ³€κ²½ κ°€λ¥
					updateServerProgress(elapsedSeconds);

				}, 1000); // 1000ms = 1μ΄
			});

			// μ„λ²„ μ—…λ°μ΄νΈ ν•¨μ (fetch API)
			function updateServerProgress(currentSeconds) {

				const formData = new FormData();
				formData.append("watched_seconds", currentSeconds);

				fetch(`/enrollment/progress/${classesId}`, {
					method: "POST",
					headers: {
						[csrfHeader]: csrfToken
					},
					body: formData
				})
					.then(response => {
						if (!response.ok) {
							console.error("μ§„λ„μ¨ ν†µμ‹  μ¤λ¥");
						}
					})
					.catch(error => console.error("μ§„λ„μ¨ μ „μ†΅ μ‹¤ν¨", error));
			}

		</script>
	</th:block>
</body>

</html>