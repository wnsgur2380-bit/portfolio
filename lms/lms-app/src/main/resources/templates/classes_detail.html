<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security6" layout:decorate="~{layout}">

<head>
	<title th:text="${classes != null ? classes.title : '강의 상세보기'}">강의 상세보기</title>
</head>

<body>
	<th:block layout:fragment="content">
		<div class="container my-4">

			<div class="mb-4 pb-3 border-bottom">
				<h2 class="fw-bold mb-3">
					<span th:text="${classes?.title}">강의 제목</span>
					<span class="badge bg-info ms-2 align-middle fs-6" th:text="${classes?.level?.levelName ?: 'N/A'}"
						th:classappend="${classes?.level == null ? 'bg-secondary' : 
                                           (classes.level.levelId == 1 ? 'bg-info' : 
                                           (classes.level.levelId == 2 ? 'bg-primary' : 'bg-danger'))}">레벨</span>
				</h2>
				<div class="row small text-muted">
					<div class="col-md-4 mb-2">
						<i class="bi bi-person-fill me-1"></i>
						<strong>강사:</strong> <span th:text="${classes?.user?.userName}">강사명</span>
					</div>
					<div class="col-md-4 mb-2">
						<i class="bi bi-calendar-check me-1"></i>
						<strong>등록일:</strong> <span
							th:text="${classes?.classesCdate != null ? #temporals.format(classes.classesCdate, 'yyyy-MM-dd') : ''}">등록일</span>
					</div>
					<div class="col-md-4 mb-2 text-md-end">
						<i class="bi bi-people-fill me-1"></i>
						<span th:text="|수강생 ${enrollmentCount}명|">수강생 0명</span>
					</div>
				</div>
			</div>

			<div class="row mb-5">
				<div class="col-lg-12">
					<div th:if="${classes.classesImg != null}" class="mb-4 text-center bg-light p-3 rounded">
						<img th:src="${classes.classesImg}" class="img-fluid rounded shadow-sm"
							style="max-height: 500px; object-fit: contain;" alt="강의 이미지">
					</div>

					<div class="card shadow-sm">
						<div class="card-body">
							<h5 class="card-title border-bottom pb-2 mb-3 fw-bold">강의 소개</h5>
							<p class="card-text" style="white-space: pre-wrap; line-height: 1.8;"
								th:text="${classes.classesContent}">강의 내용</p>
						</div>
					</div>
				</div>
			</div>

			<div class="d-flex justify-content-end align-items-center mb-5">

				<div
					th:if="${isEnrolled or #authorization.expression('hasRole(''ROLE_ADMIN'')') or #authorization.expression('hasRole(''ROLE_INSTRUCTOR'')')}">

					<a th:href="@{|/classes/watch/${classes.classesId}|}" class="btn btn-success btn-lg shadow-sm">
						<i class="bi bi-play-circle-fill me-1"></i> 강의 영상 시청하기
					</a>

					<!--질문하기 추가 -->
					<a th:if="${isEnrolled}" th:href="@{/question/create(classesId=${classes.classesId})}"
						class="btn btn-dark ms-2">
						<i class="bi bi-play-circle-fill"></i> 질문하기
					</a>

					<span th:if="${isEnrolled and isCompleted}" class="btn btn-lg btn-outline-success ms-2 disabled">
						<i class="bi bi-check-circle-fill me-1"></i> 수강 완료
					</span>
				</div>

				<div
					th:unless="${isEnrolled or #authorization.expression('hasRole(''ROLE_ADMIN'')') or #authorization.expression('hasRole(''ROLE_INSTRUCTOR'')')}">

					<form sec:authorize="isAuthenticated()" th:action="@{|/enrollment/create/${classes.classesId}|}"
						method="post">
						<button type="submit" class="btn btn-primary btn-lg shadow-sm"
							onclick="return confirm('이 강의를 수강 신청하시겠습니까?');">
							<i class="bi bi-journal-check me-1"></i> 수강신청 하기
						</button>
					</form>

					<a sec:authorize="!isAuthenticated()" th:href="@{/user/login}"
						class="btn btn-primary btn-lg shadow-sm">
						<i class="bi bi-box-arrow-in-right me-1"></i> 로그인 후 수강신청
					</a>
				</div>
			</div>

			<div sec:authorize="isAuthenticated()"
				th:if="${classes != null and classes.user != null and (#authentication.name == classes.user.userId or #authorization.expression('hasRole(''ROLE_ADMIN'')'))}"
				class="text-end border-top pt-3">

				<a th:href="@{|/classes/edit/${classes.classesId}|}" class="btn btn-outline-secondary me-2">
					<i class="bi bi-pencil-square me-1"></i> 강의 수정
				</a>

				<form th:action="@{|/classes/delete/${classes.classesId}|}" method="post" style="display:inline;">
					<button type="submit" class="btn btn-outline-danger"
						onclick="return confirm('정말 이 강의를 삭제하시겠습니까? 복구할 수 없습니다.');">
						<i class="bi bi-trash me-1"></i> 삭제
					</button>
				</form>
			</div>

			<div class="mt-3">
				<a th:href="@{/classes/list}" class="text-decoration-none text-muted">
					<i class="bi bi-arrow-left"></i> 목록으로 돌아가기
				</a>
			</div>

		</div>
	</th:block>
</body>

</html>